# .azure-pipelines/test-scenario-1-missing-variable.yml
# Test Scenario 1: Missing Terraform Variable
# This will FAIL initially, but SUCCEED after AI fixes it

trigger:
  branches:
    include:
    - main
    - refs/pull/*/merge

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: SCENARIO
    value: 'missing-variable'

# Update .azure-pipelines/test-scenario-1-missing-variable.yml

stages:
  - stage: Infrastructure
    displayName: 'Validate Terraform'
    jobs:
      - job: TerraformValidate
        displayName: 'Terraform Validate & Plan'
        steps:
          - bash: |
              wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
              echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
              sudo apt update && sudo apt install terraform -y
            displayName: 'Install Terraform'
          
          # ADD THIS: Azure CLI Login
          - task: AzureCLI@2
            displayName: 'Terraform Validate with Azure Auth'
            inputs:
              azureSubscription: 'ai-poc'  # ‚Üê Add your service connection
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              addSpnToEnvironment: true
              inlineScript: |
                cd $(Build.SourcesDirectory)/infrastructure/test-apps/infra-only/terraform/scenarios/missing-variable
                
                echo "Working directory: $(pwd)"
                echo "variables.tf content:"
                cat variables.tf
                echo ""
                
                # Set Azure credentials for Terraform
                export ARM_CLIENT_ID=$servicePrincipalId
                export ARM_CLIENT_SECRET=$servicePrincipalKey
                export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
                export ARM_TENANT_ID=$tenantId
                
                terraform init
                terraform validate
                terraform plan