# .azure-pipelines/test-scenario-1-missing-variable.yml
# Test Scenario 1: Missing Terraform Variable
# This will FAIL initially, but SUCCEED after AI fixes it

trigger:
  branches:
    include:
    - main
    - refs/pull/*/merge

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: SCENARIO
    value: 'missing-variable'

stages:
  - stage: Infrastructure
    displayName: 'Deploy Infrastructure'
    jobs:
      - job: TerraformDeploy
        displayName: 'Terraform Validate & Plan'
        steps:
          # Install Terraform
          - bash: |
              echo "Installing Terraform..."
              wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
              echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
              sudo apt update && sudo apt install terraform -y
              terraform --version
            displayName: 'Install Terraform'
          
          # Use ACTUAL files from repository
          - bash: |
              cd $(Build.SourcesDirectory)/infrastructure/test-apps/infra-only/terraform/scenarios/missing-variable
              
              echo "ğŸ“ Working directory: $(pwd)"
              echo ""
              echo "ğŸ“„ Files in directory:"
              ls -la
              echo ""
              echo "ğŸ“ main.tf:"
              cat main.tf
              echo ""
              echo "ğŸ“ variables.tf:"
              cat variables.tf
              echo ""
            displayName: 'Show Terraform Config'
          
          # Terraform Init
          - bash: |
              cd $(Build.SourcesDirectory)/infrastructure/test-apps/infra-only/terraform/scenarios/missing-variable
              echo "ğŸ”§ Running terraform init..."
              terraform init
            displayName: 'Terraform Init'
          
          # Terraform Validate
          - bash: |
              cd $(Build.SourcesDirectory)/infrastructure/test-apps/infra-only/terraform/scenarios/missing-variable
              echo "âœ… Running terraform validate..."
              terraform validate
            displayName: 'Terraform Validate'
          
          # Terraform Plan
          - bash: |
              cd $(Build.SourcesDirectory)/infrastructure/test-apps/infra-only/terraform/scenarios/missing-variable
              echo "ğŸ“Š Running terraform plan..."
              terraform plan
            displayName: 'Terraform Plan'